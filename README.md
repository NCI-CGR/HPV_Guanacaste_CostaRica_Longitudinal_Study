# Description

The directory includes <a href="https://snakemake.readthedocs.io/en/stable/"> snakemake </a> workflow for variant calling used in the HR-HPV longitudinal study. The input to the pipeline are the bam files generated by <a href="https://github.com/iontorrent/TS/tree/master/Analysis/TMAP"> Tmap </a> upon mapping the Ion Torrent sequenced reads to the reference genome. The pipeline assumes that the raw data has already been mapped to the reference genome (which includes the 12 HR-HPV reference genomes and human genome). The HR-HPV reference genomes used in our study is included (references/HPV*.fasta).

The pipeline will first perform a quality control on the mapped reads and only retain the high quality reads. Next, it will perform variant calling to detect consensus HPV variants and then another variant call to detect within-host low-VAF variants. The output from the variant calling pipeline are the VCF files and consensus viral genome fasta files.

# Installation and Execution
You will first need to download and install the <a href="https://github.com/domibel/IonTorrent-VariantCaller"> torrent variant caller (TVC)</a> and the <a href="https://pcingola.github.io/SnpEff/download/"> SNPEff annotation tool</a>. Setup the SNPEff database for all the HR-HPV types (use the references/genes.gtf file). Then create and activate a conda environment to install the remaining packages following the instructions below. 

```
conda env create -f variant_calling_env.yaml
conda activate variant_call_env
```

Before running the pipeline, you will need to update the config/hpv_config.yaml file with the correct paths and update the parse_samples and parse_blanks functions in the config/config_functions.py to capture the correct sample ids. 

# Input
The workflow inputs aligned bams as designated in the hpv_config.yaml file.

# Output
The workflow outputs an annotated vcf file, a bam file filtered for just the amplicon regions, and a consensus fasta file for each sample.
